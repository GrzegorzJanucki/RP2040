#include "jFont.h"

// int GetFontIndex(char c, font_info_t* pFontInfo);

void drawPixel(int16_t x, int16_t y, uint8_t colour);

static const char Font7SegsChars[] = {'0','1', '2', '3', '4', '5', '6', '7', '8', '9', ' ', '.', '-','\0'}; // '\0' must be added to the set
static const uint8_t Font7SegsWidths[] = {15,5,15,15,15,15,15,15,15,15,9,5,13,17};
static const uint8_t Font7SegsData[] = {
    /*Bitmap Raw Data begin +++*/
/*The expected raw bitmap size is 1386 Bytes */
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,232,0,127,248,0,64,24,0,96,24,0,96,24,
0,96,24,0,96,24,0,96,24,0,96,24,0,64,8,0,0,0,0,64,8,0,96,24,0,96,24,0,96,24,0,96,
24,0,96,24,0,96,24,0,64,24,0,127,248,0,63,232,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,32,0,0,96,0,0,96,0,0,96,0,
0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,32,0,0,0,0,0,32,0,0,96,0,0,96,0,0,96,
0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,232,0,127,248,0,0,24,
0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,8,0,31,240,0,95,240,0,96,0,0,96,
0,0,96,0,0,96,0,0,96,0,0,96,0,0,64,0,0,127,240,0,63,240,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,232,0,63,248,
0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,8,0,31,240,0,31,248,0,0,
24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,127,248,0,63,232,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,8,0,31,240,0,31,
248,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,8,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,63,240,0,127,240,0,64,0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,31,
240,0,31,248,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,127,248,0,63,232,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,63,240,0,127,240,0,64,0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,0,0,96,
0,0,31,240,0,95,248,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,64,24,0,127,248,0,
63,232,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,63,232,0,127,248,0,64,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,
24,0,64,8,0,0,0,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,
0,24,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,63,232,0,127,248,0,64,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,
24,0,96,24,0,96,8,0,31,240,0,95,248,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,96,24,0,
64,24,0,127,248,0,63,232,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,63,232,0,127,248,0,64,24,0,96,24,0,96,24,0,96,24,0,96,
24,0,96,24,0,96,24,0,96,8,0,31,240,0,31,248,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,
0,24,0,0,24,0,127,248,0,63,232,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,96,0,0,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,224,0,63,224,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,254,0,63,255,0,32,
3,0,48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,
48,3,0,48,3,0,48,3,0,48,3,0,48,3,0,32,3,0,63,255,0,63,254,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0
/*Bitmap Raw Data end ---*/
};

font_info_t Font7SegsInfo = {
    .stride = 3,
    .width = 18,
    .height = 33,
    .pData = Font7SegsData,
    .pWidths = Font7SegsWidths,
    .pCharset = Font7SegsChars
};

//////////////////////////////////////////////////////////////////////////////
static const char FontDigitalChars[] = {'0','1', '2', '3', '4', '5', '6', '7', '8', '9', ' ', '.', '-','\0'}; // '\0' must be added to the set
static const uint8_t FontDigitalWidths[] = {19,18,18,19,19,18,19,18,19,19,6,6,9,16};
static const uint8_t FontDigitalData[] = {

0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,252,0,31,255,
0,63,255,0,56,7,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,
3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,7,128,63,255,0,31,255,0,15,252,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,7,240,0,7,240,0,7,240,0,0,112,0,0,112,0,0,112,0,0,
112,0,0,112,0,0,112,0,0,112,0,0,112,0,0,112,0,0,112,0,0,112,0,0,112,0,0,112,0,0,112,0,
0,112,0,0,112,0,0,112,0,0,112,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,
248,0,63,254,0,63,254,0,0,15,0,0,7,0,0,7,0,0,7,0,0,7,0,0,15,0,7,254,0,31,254,0,
31,248,0,60,0,0,56,0,0,56,0,0,56,0,0,56,0,0,56,0,0,63,255,0,63,255,0,63,255,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,252,0,63,254,0,31,254,0,0,7,0,0,7,0,
0,7,0,0,7,0,0,7,0,0,14,0,1,254,0,1,252,0,1,254,0,0,7,0,0,7,0,0,7,0,0,7,
0,0,7,0,0,7,0,31,254,0,63,254,0,63,252,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,231,0,1,231,0,1,199,0,3,199,0,3,135,0,7,7,0,15,7,0,14,7,0,30,7,0,28,7,
0,60,7,0,56,7,0,63,255,0,63,255,0,31,255,0,0,7,0,0,7,0,0,7,0,0,7,0,0,7,0,0,
7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,255,0,63,255,0,63,255,0,56,0,
0,56,0,0,56,0,0,56,0,0,56,0,0,63,248,0,63,252,0,63,254,0,0,15,0,0,7,0,0,7,0,0,
7,0,0,7,0,0,7,0,0,15,0,63,254,0,63,254,0,63,248,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,15,255,0,31,255,0,63,255,0,56,0,0,56,0,0,56,0,0,56,0,0,56,0,0,63,
252,0,63,255,0,63,255,128,56,7,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,63,255,128,
31,255,0,15,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,254,0,63,255,0,63,
255,0,0,15,0,0,14,0,0,30,0,0,28,0,0,28,0,0,60,0,0,56,0,0,120,0,0,112,0,0,112,0,
0,224,0,0,224,0,1,224,0,1,192,0,1,192,0,3,128,0,3,128,0,7,128,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,15,254,0,31,255,0,63,255,128,56,3,128,56,3,128,56,3,128,56,3,128,
56,3,128,60,7,128,31,255,0,15,254,0,31,255,0,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,
128,63,255,128,31,255,0,15,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,254,0,
31,255,0,63,255,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,56,3,128,63,255,128,31,255,
128,15,255,128,0,3,128,0,3,128,0,3,128,0,3,128,0,3,128,31,255,128,31,255,0,31,254,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,48,0,0,120,0,0,120,0,0,48,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,128,0,255,128,0,255,128,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,252,0,63,
252,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,
48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,48,12,0,63,252,
0,63,252,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
/*Bitmap Raw Data end ---*/
};

font_info_t FontDigital32Info = {
    .stride = 3,
    .width = 20,
    .height = 38,
    .pData = FontDigitalData,
    .pWidths = FontDigitalWidths,
    .pCharset = FontDigitalChars
};

static const char FontDigital18Chars[] = {'0','1', '2', '3', '4', '5', '6', '7', '8', '9', ' ', '.', '-','\0'}; // '\0' must be added to the set
static const uint8_t FontDigital18Widths[] = {11,10,10,10,10,10,11,10,11,11,3,3,5,9};
static const uint8_t FontDigital18Data[] = {
    /*Bitmap Raw Data begin +++*/
/*The expected raw bitmap size is 588 Bytes */
0,0,0,0,0,0,0,0,0,0,63,0,127,128,96,192,96,192,96,192,96,192,96,192,96,192,96,192,96,192,127,128,
63,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,30,0,30,0,6,0,6,0,6,0,6,0,
6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,127,0,
127,0,1,128,1,128,1,128,31,0,127,0,96,0,96,0,96,0,127,0,127,128,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,127,0,127,0,1,128,1,128,1,0,15,0,15,0,1,128,1,128,1,128,127,0,127,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,13,128,25,128,25,128,49,128,49,128,97,128,97,128,
127,128,127,128,1,128,1,128,1,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,127,128,127,0,
96,0,96,0,124,0,127,0,1,0,1,128,1,128,1,128,127,0,127,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,63,128,127,128,96,0,96,0,126,0,127,128,96,128,96,192,96,192,96,192,127,128,63,128,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,127,128,127,128,1,128,3,0,3,0,6,0,6,0,4,0,
12,0,12,0,24,0,24,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,128,127,128,96,192,
96,192,96,128,63,128,127,128,96,128,96,192,96,192,127,128,63,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,63,0,127,128,96,192,96,192,96,192,96,192,127,192,31,192,0,192,0,192,63,128,127,128,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,64,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,248,0,248,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,127,0,65,0,65,0,65,0,65,0,65,0,65,0,65,0,65,0,65,0,65,0,
65,0,127,0,0,0,0,0,0,0,0,0,
/*Bitmap Raw Data end ---*/
};

font_info_t FontDigital18Info = {
    .stride = 2,
    .width = 12,
    .height = 21,
    .pData = FontDigital18Data,
    .pWidths = FontDigital18Widths,
    .pCharset = FontDigital18Chars
};

int GetCharFontIndex(char ch, font_info_t *pFontInfo)
{
    char* chars = (char*)pFontInfo->pCharset;
    char c;
    int i = 0;
    while((c = chars[i]) != '\0' && c != ch){
        i++;
    }
    return (c == ch) ? i : -1 ;
}

int GetCharFontWidth(int index, font_info_t* pFontInfo)
{
    if (index < 0)
        return -1;
    return pFontInfo->pWidths[index];
}

uint8_t *GetCharFontData(int index, font_info_t* pFontInfo)
{
    if (index < 0)
        return NULL;
    return (uint8_t*)&(pFontInfo->pData[index*pFontInfo->height*pFontInfo->stride]);
}

int16_t WriteCharFont(int16_t x, int16_t y, char value, font_info_t* pFontInfo)
{
    int xx=x, yy=y;
    int idx = GetCharFontIndex(value, pFontInfo);
    int w = GetCharFontWidth(idx, pFontInfo);
    int h = pFontInfo->height;
    int s = pFontInfo->stride;
    uint8_t *pChData = GetCharFontData(idx, pFontInfo);
    uint8_t *pRow = pChData;
    uint8_t *pByte = pRow;
    uint8_t mask = 0x80;
 
    for (int i = 0; i < h; i++)
    {
        for (int j = 0; j <= w; j++)
        {
            if (((j % 8)==0)&&(j>0))
            {
                mask = 0x80;
                pByte++;
            }

            if ((*(pByte)) & mask){
                drawPixel(xx, yy, 1);
            }
            else {
                drawPixel(xx, yy, 0);
            }
            mask = mask >> 1;           
            xx++;
        }
        mask = 0x80;
        pRow += s;
        pByte = pRow;
        yy++;
        xx = x;
    }
    return w;
}

int16_t PrintStringFont(int16_t x_left, int16_t y_top, char* pString, font_info_t* pFontInfo)
{
    int16_t x = x_left, y = y_top, dx = 0;
    int i = 0;
    do
    {
        x += dx;
        dx = WriteCharFont(x, y, pString[i], pFontInfo);
    } while ((pString[++i] != '\0'));
    return x + dx - x_left;
}

int16_t WriteCharFontClip(int16_t x, int16_t y, int16_t x_right, int16_t y_bottom, char value, font_info_t* pFontInfo){
    int xx=x, yy=y;
    int idx = GetCharFontIndex(value, pFontInfo);
    int w = GetCharFontWidth(idx, pFontInfo);
    int h = pFontInfo->height;
    int s = pFontInfo->stride;
    uint8_t *pChData = GetCharFontData(idx, pFontInfo);
    uint8_t *pRow = pChData;
    uint8_t *pByte = pRow;
    uint8_t mask = 0x80;
 
    for (int i = 0; i < h; i++)
    {
        for (int j = 0; j <= w; j++)
        {
            if (((j % 8)==0)&&(j>0))
            {
                mask = 0x80;
                pByte++;
            }
            if ((xx < x_right) && (yy < y_bottom) && (xx > x) && (yy > y))
            {
                if ((*(pByte)) & mask)
                {
                    drawPixel(xx, yy, 1);
                }
                else
                {
                    drawPixel(xx, yy, 0);
                }
            }
            mask = mask >> 1;           
            xx++;
        }
        mask = 0x80;
        pRow += s;
        pByte = pRow;
        yy++;
        xx = x;
    }
    return w;
}

int16_t PrintStringFontClip(int16_t x_left, int16_t y_top, int16_t x_right, int16_t y_bottom,
                            char* pString, font_info_t* pFontInfo){
    int16_t x = x_left, y = y_top, dx = 0;
    int i = 0;
    do
    {
        x += dx;
        dx = WriteCharFontClip(x, y, x_right, y_bottom, pString[i], pFontInfo);
    } while ((pString[++i] != '\0'));
    return x + dx - x_left;
}